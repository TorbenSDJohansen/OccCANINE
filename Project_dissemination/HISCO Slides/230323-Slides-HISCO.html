<!DOCTYPE html>
<html lang="" xml:lang="">
  <head>
    <title>230323-Slides-HISCO.knit</title>
    <meta charset="utf-8" />
    <script src="libs/header-attrs-2.21/header-attrs.js"></script>
    <link href="libs/remark-css-0.0.1/default.css" rel="stylesheet" />
    <link href="libs/remark-css-0.0.1/default-fonts.css" rel="stylesheet" />
    <script src="libs/htmlwidgets-1.6.2/htmlwidgets.js"></script>
    <link href="libs/datatables-css-0.0.0/datatables-crosstalk.css" rel="stylesheet" />
    <script src="libs/datatables-binding-0.28/datatables.js"></script>
    <script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
    <link href="libs/dt-core-1.13.4/css/jquery.dataTables.min.css" rel="stylesheet" />
    <link href="libs/dt-core-1.13.4/css/jquery.dataTables.extra.css" rel="stylesheet" />
    <script src="libs/dt-core-1.13.4/js/jquery.dataTables.min.js"></script>
    <link href="libs/crosstalk-1.2.0/css/crosstalk.min.css" rel="stylesheet" />
    <script src="libs/crosstalk-1.2.0/js/crosstalk.min.js"></script>
  </head>
  <body>
    <textarea id="source">

class: center, inverse

&lt;style type="text/css"&gt;
.pull-left {
  float: left;
  width: 44%;
}
.pull-right {
  float: right;
  width: 44%;
}
.pull-right ~ p {
  clear: both;
}
&lt;/style&gt;



# Breaking the HISCO Barrier: AI and Occupational Data Standardization
## Christian MÃ¸ller-Dahl
## Christian Vedel
### University of Southern Denmark, HEDG

#### Twitter: @ChristianVedel,
#### Email: christian-vs@sam.sdu.dk
#### Updated 2023-09-07 

---

# Introduction
.pull-left[
### Motivation
- Labelling is tedious, expensive and error-prone  
- We collectively poor thousands of hours into similar work
- 4 mil. `\(\rightarrow\)` 96k `\(\rightarrow\)` 605 days of work 


### This presentation
- **Automatic tool to make HISCO labels** 
- Early work in progress 
- 98 percent precision
- How it is done 
]

.pull-right[
![Iron_and_coal](Figures/Iron_and_coal.jpg)
*Willam Bell Scott (1861) "Iron and Coal" (Wikimedia)*

]

---
# HISCO codes
- Derived from ISCO (International Standard Classification of Occupations) 
- Invented for the sake of international comparability  
- Introduced by Leuwen, Maas, Miles (2002) based on ISCO68  
- Hiearchical structure well suited for analysis
- Common application: Convert to ranking (HISCAM, HISCLASS, etc. )
- Usually labelled with 'smart' manual methods 

![HISCO](Figures/HISCO structure.png)


---
.pull-left[
## The naive solution
- List all unique occupational descriptions and label them e.g. "farm servant: 62120"
- Label via lookup table  

## The challenge
- 17865 different occupational descriptions fit with "farm servant" in DK censuses ("in service", "servant girl", "servant boy", "servant woman", "servant karl")
- HISCO has ~2000 occupational classes, each with similar complexity in writing 
- Spelling mistakes, **negations**, and different spelling conventions

]

--
.pull-right[
## The solution
![arhc_small](Figures/Architecture_small.png)
- Use machine learning! 
- Multi-label multiple classification 
- Trivial machine learning problem 
- Apply tricks from the machine learning literature to improve performance on unseen examples
]

---

.pull-left[
## The tricks

- Unseen test and validation data 
- LSTM reccurent: Reads with memory "lives of fishing and farm work" (Hochreiter, Schmidhuber, 1997)
- Overparameterized neural network: More parameters than data (Allen-Zhu, Li, Liang, 2018) 
- Regularization via dropout: Some neurons are randomly disabled in training (Srivastava et al 2014) 
- Embedding: Represent language in high-dimensional space  (Mandelbaum, 2016)
- Data augmentation (Moris et al, 2020): 
  + "farmer": {"farmtr", "fermer", "yellow farmer"}
]


.pull-right[
**Overfitting**
![Overfitting](https://upload.wikimedia.org/wikipedia/commons/thumb/1/19/Overfitting.svg/300px-Overfitting.svg.png)
(Wikimedia)

### Metrics
- Accuracy
- Precision
- Recall 
- F1 
- Micro- and macro-level 
- In training: Binary cross-entropy (differentiable)
]

---
# Data sources 
.pull-left[
### Training data

- Danish Census data (1787-1901) 
  + Has manual HISCO labels for 1787, 1801, 1845, 1880 
  + 3.7 mio labels 
- UK marriage certificates (1837-1939)
  + Labelled Clark, Cummins, Curtis (2022)
  + 4.2 mio labelled observations 
  
- *Adequate performance down to 10.000 labels*
]

.pull-right[
### Other data
- Swedish census data
- Norwegian census data
- Dutch family history data 
- Labelled biographies
- IPUMS
- Barcelona Historical Marriage Database

### Call for data!
- If you have something with HISCO labels on it, please send it to christian-vs@sam.sdu.dk. I owe you HISCO codes 

]


---
# The architecture
![Arch2](Figures/Architecture.png)

### Training 
- Model starts at random state
- Continuously tweaked towards more correct predictions

### Ongoing work
- Replacing the brains by a transformer model (BERT) *akin to a chatGPT-frankenstein*

---
# Training
![Training](Figures/Training process.png)

### Stopping condition 
- When validation loss has not improved for 10 epochs training stops

---
# The product

```r
# Example prompts
string_to_hisco("A farmer")
string_to_hisco("Tailor of beautiful dresses")
string_to_hisco("The train's fireman")
```

--


```
##                        string hisco                    description
## 1                    A farmer 61110                 General Farmer
## 2 Tailor of beautiful dresses 79100 Tailor, Specialisation Unknown
## 3         The train's fireman 98330    Railway SteamEngine Fireman
```


---
# The performance (1/x)

*DK data based on 300.000 validation observations*

### Macro level performance


|level |    recall| precision|        f1|
|:-----|---------:|---------:|---------:|
|macro | 0.9707673| 0.9805047| 0.9755535|


--

### Micro level


|level |    recall| precision|        f1|
|:-----|---------:|---------:|---------:|
|micro | 0.8228573| 0.9100653| 0.8989688|


---
# The performance (2/7)
![Recalls](Figures/Recall.png)

---
# The performance (2/7)
![Recalls](Figures/Precision.png)
---
# The performance (2/7)
![Recalls](Figures/F1.png)

---
# The performance (3/7): Confusion matrix
![Conf_mat1](Figures/conf_mat_lvl5.png)
---
# The performance (3/7): Confusion matrix
![Conf_mat1](Figures/conf_mat_lvl4.png)
---
# The performance (3/7): Confusion matrix
![Conf_mat1](Figures/conf_mat_lvl3.png)

---
# The performance (3/7): Confusion matrix
![Conf_mat1](Figures/conf_mat_lvl2.png)
---
# The performance (3/7): Confusion matrix
![Conf_mat1](Figures/conf_mat_lvl1.png)

---
# The performance (4/7)

### Results for fewer samples

<div class="datatables html-widget html-fill-item-overflow-hidden html-fill-item" id="htmlwidget-bf7a69cb5b677fc9b63d" style="width:100%;height:auto;"></div>
<script type="application/json" data-for="htmlwidget-bf7a69cb5b677fc9b63d">{"x":{"filter":"none","vertical":false,"fillContainer":false,"data":[["1","2","3","4","5","6","7","8","9","10","11","12","13"],["10^3","10^3","10^3","10^4","10^4","10^4","10^5","10^5","10^5","All","All","10^5","All"],[0,0.2,0.5,0,0.2,0.5,0,0.2,0.5,0,0.2,0.2,0.2],["DK","DK","DK","DK","DK","DK","DK","DK","DK","DK","DK","UK","UK"],[0.698,0.877,0.842,0.831,0.9360000000000001,0.947,0.959,0.966,0.963,0.967,0.972,0.96,0.973],[0.6889999999999999,0.887,0.866,0.907,0.949,0.959,0.971,0.972,0.974,0.973,0.975,0.961,0.972],[0.707,0.867,0.82,0.768,0.924,0.9360000000000001,0.948,0.96,0.953,0.962,0.971,0.96,0.974]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>sample_size<\/th>\n      <th>aug. prob.<\/th>\n      <th>source<\/th>\n      <th>f1<\/th>\n      <th>precision<\/th>\n      <th>recall<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"pageLength":8,"columnDefs":[{"className":"dt-right","targets":[2,4,5,6]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false,"lengthMenu":[8,10,25,50,100]}},"evals":[],"jsHooks":[]}</script>


---
# The performance (5/6)

### Results for fewer samples

![Fewer](Figures/Performance_in_different_settings.png)

---
# The performance (6/7)
### What about SES scores?
<div class="datatables html-widget html-fill-item-overflow-hidden html-fill-item" id="htmlwidget-5658a9941197f54086c4" style="width:100%;height:auto;"></div>
<script type="application/json" data-for="htmlwidget-5658a9941197f54086c4">{"x":{"filter":"none","vertical":false,"fillContainer":false,"data":[["1","2","3","4"],["hisclass","hisclass_5","socpo","hiscam_u1"],[0.00161509,0.00203475,-0.0361373,-0.000976822],[0.480137,0.202318,2.71758,1.55728],[0.480139,0.202328,2.71782,1.55728],[1,1,1,37.18],[13,5,42,99]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>Statistic<\/th>\n      <th>Bias<\/th>\n      <th>Standard_error<\/th>\n      <th>RMSE<\/th>\n      <th>min<\/th>\n      <th>max<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"pageLength":8,"columnDefs":[{"className":"dt-right","targets":[2,3,4,5,6]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false,"lengthMenu":[8,10,25,50,100]}},"evals":[],"jsHooks":[]}</script>

---
# Performance (7/7) 
**Some preliminary results** 
- Even better performance for UK data 
- 90% accuracy on Copenhagen burial records (100 random samples)
- ~90% accuracy in Norwegian census data
- 80% accuracy on Faroe Island data 

---


#### An applcation

![Event](Figures/Map.png)

---
# Empirical strategy

`$$log(y_{it}) = Affected_i \times Year_t \beta_t + FE + \varepsilon_{it}$$`


---
### Breach `\(\rightarrow\)` Parishes with fishermen
![Fish1](Figures/fish_extensive.png)

---
# Conclusion

### Steps ahead
- Transferlearning: Give it 1000 samples to fine tune it yo your need 
- Application oriented validation: 
  + Can we replicate econometrics results with same outcomes in human/computer labels 
  + What is the human error rate? 

### Please let me know
- How do we make automatic HISCO-labeling a broadly available tool for the profession? Is it something you can see yourself using? 
- &lt;p style="color:red;"&gt;If you have data to HISCO codes, please send it to me (christian-vs@sam.sdu.dk)&lt;/p&gt;
- &lt;p style="color:red;"&gt;In return I owe you HISCO codes for your project!&lt;/p&gt;


    </textarea>
<style data-target="print-only">@media screen {.remark-slide-container{display:block;}.remark-slide-scaler{box-shadow:none;}}</style>
<script src="https://remarkjs.com/downloads/remark-latest.min.js"></script>
<script>var slideshow = remark.create({
"highlightStyle": "github",
"highlightLines": true,
"countIncrementalSlides": false
});
if (window.HTMLWidgets) slideshow.on('afterShowSlide', function (slide) {
  window.dispatchEvent(new Event('resize'));
});
(function(d) {
  var s = d.createElement("style"), r = d.querySelector(".remark-slide-scaler");
  if (!r) return;
  s.type = "text/css"; s.innerHTML = "@page {size: " + r.style.width + " " + r.style.height +"; }";
  d.head.appendChild(s);
})(document);

(function(d) {
  var el = d.getElementsByClassName("remark-slides-area");
  if (!el) return;
  var slide, slides = slideshow.getSlides(), els = el[0].children;
  for (var i = 1; i < slides.length; i++) {
    slide = slides[i];
    if (slide.properties.continued === "true" || slide.properties.count === "false") {
      els[i - 1].className += ' has-continuation';
    }
  }
  var s = d.createElement("style");
  s.type = "text/css"; s.innerHTML = "@media print { .has-continuation { display: none; } }";
  d.head.appendChild(s);
})(document);
// delete the temporary CSS (for displaying all slides initially) when the user
// starts to view slides
(function() {
  var deleted = false;
  slideshow.on('beforeShowSlide', function(slide) {
    if (deleted) return;
    var sheets = document.styleSheets, node;
    for (var i = 0; i < sheets.length; i++) {
      node = sheets[i].ownerNode;
      if (node.dataset["target"] !== "print-only") continue;
      node.parentNode.removeChild(node);
    }
    deleted = true;
  });
})();
// add `data-at-shortcutkeys` attribute to <body> to resolve conflicts with JAWS
// screen reader (see PR #262)
(function(d) {
  let res = {};
  d.querySelectorAll('.remark-help-content table tr').forEach(tr => {
    const t = tr.querySelector('td:nth-child(2)').innerText;
    tr.querySelectorAll('td:first-child .key').forEach(key => {
      const k = key.innerText;
      if (/^[a-z]$/.test(k)) res[k] = t;  // must be a single letter (key)
    });
  });
  d.body.setAttribute('data-at-shortcutkeys', JSON.stringify(res));
})(document);
(function() {
  "use strict"
  // Replace <script> tags in slides area to make them executable
  var scripts = document.querySelectorAll(
    '.remark-slides-area .remark-slide-container script'
  );
  if (!scripts.length) return;
  for (var i = 0; i < scripts.length; i++) {
    var s = document.createElement('script');
    var code = document.createTextNode(scripts[i].textContent);
    s.appendChild(code);
    var scriptAttrs = scripts[i].attributes;
    for (var j = 0; j < scriptAttrs.length; j++) {
      s.setAttribute(scriptAttrs[j].name, scriptAttrs[j].value);
    }
    scripts[i].parentElement.replaceChild(s, scripts[i]);
  }
})();
(function() {
  var links = document.getElementsByTagName('a');
  for (var i = 0; i < links.length; i++) {
    if (/^(https?:)?\/\//.test(links[i].getAttribute('href'))) {
      links[i].target = '_blank';
    }
  }
})();
// adds .remark-code-has-line-highlighted class to <pre> parent elements
// of code chunks containing highlighted lines with class .remark-code-line-highlighted
(function(d) {
  const hlines = d.querySelectorAll('.remark-code-line-highlighted');
  const preParents = [];
  const findPreParent = function(line, p = 0) {
    if (p > 1) return null; // traverse up no further than grandparent
    const el = line.parentElement;
    return el.tagName === "PRE" ? el : findPreParent(el, ++p);
  };

  for (let line of hlines) {
    let pre = findPreParent(line);
    if (pre && !preParents.includes(pre)) preParents.push(pre);
  }
  preParents.forEach(p => p.classList.add("remark-code-has-line-highlighted"));
})(document);</script>
<style>
.logo {
  background-image: url(Logos.png);
  background-size: contain;
  background-repeat: no-repeat;
  position: absolute;
  top: 1em;
  right: 1em;
  width: 83px;
  height: 96px;
  z-index: 0;
}
</style>

<script>
document
  .querySelectorAll(
    '.remark-slide-content' +
    ':not(.title-slide)' +
    // insert more to hide here
    ':not(.inverse)' +
    ':not(.hide-logo)'
  )
  .forEach(el => {
    el.innerHTML += '<div class="logo"></div>';
  });
</script>

<script>
slideshow._releaseMath = function(el) {
  var i, text, code, codes = el.getElementsByTagName('code');
  for (i = 0; i < codes.length;) {
    code = codes[i];
    if (code.parentNode.tagName !== 'PRE' && code.childElementCount === 0) {
      text = code.textContent;
      if (/^\\\((.|\s)+\\\)$/.test(text) || /^\\\[(.|\s)+\\\]$/.test(text) ||
          /^\$\$(.|\s)+\$\$$/.test(text) ||
          /^\\begin\{([^}]+)\}(.|\s)+\\end\{[^}]+\}$/.test(text)) {
        code.outerHTML = code.innerHTML;  // remove <code></code>
        continue;
      }
    }
    i++;
  }
};
slideshow._releaseMath(document);
</script>
<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
(function () {
  var script = document.createElement('script');
  script.type = 'text/javascript';
  script.src  = 'https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML';
  if (location.protocol !== 'file:' && /^https?:/.test(script.src))
    script.src  = script.src.replace(/^https?:/, '');
  document.getElementsByTagName('head')[0].appendChild(script);
})();
</script>
  </body>
</html>
